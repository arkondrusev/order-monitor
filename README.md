# order-monitor
Сервис предназначен для мониторинга состояния заявок (ордеров) на криптобиржах.
(В начальной версии поддерживается биржа www.okx.com)

Технологический стэк:
- Spring Boot
- Postgresql

Компоненты:
- клиент биржи. Выполняет запросы к бирже для получения статуса заявок
- клиент телеграм. Отсылает нотификации в телеграм-чат при изменении статуса заявок. Обрабатывает входящие запросы 
от пользователя телеграм на подписку и отписку на получение нотификаций.
- модуль работы с БД Postgresql. Сохраняет и получает информацию в/из БД.
- модуль анализа. Сравнивает состояния заявок на бирже и в БД, принимает решение об отправке нотификаций.
- REST API доступа к заявкам. Позволяет просматривать сохраненные в БД заявки.

Настройки:
    Файл настроек application.properties:
        spring.application.name     - указать значение "order-monitor"
        server.servlet.context-path - префикс пути для REST API. Указать значение "/api"
        spring.config.import        - ссылки на файлы настроек телеграм бота и модуля работы с биржами.
                                        Указать значение
                                        "classpath:telegram-bot.properties,classpath:stock-exchange.properties"
        database.driver             - драйвер для работы с БД. Указать org.postgresql.Driver
        spring.datasource.url       - адрес для подключения к БД. Формат jdbc:postgresql://{ip}/{db name}
        spring.datasource.username  - имя пользователя для подключения к БД
        spring.datasource.password  - пароль пользователя для подключения к БД

    Файл настроек telegram-bot.properties:
        telegram.bot-token          - токен для телеграм бота.

    Файл настроек stock-exchange.properties:
        Содержит группы реквизитов для доступа к аккаунту на бирже.
        На одной бирже может быть несколько аккаунтов.
        Для отслеживания аккаунта требуется также чтобы были созданы соответствующие записи через методы группы
        "/api/stock-exchange" и "/api/account". Имена биржи и аккаунта должны соответствовать названиям ключей - см. шаблон

        шаблон группы реквизитов.
        {stock exchange name}.api.{api account name}.key        - пример для okx: okx.api.111.key 
        {stock exchange name}.api.{api account name}.secretkey  - пример для okx: okx.api.111.secretkey
        {stock exchange name}.api.{api account name}.passphrase - пример для okx: okx.api.111.passphrase

Сценарии использования:
    
1. Подписка на получение нотификаций.
   1. Пользователь телеграм отправляет боту OrderMonitorBot команду /start
   2. модуль клиент телеграм получает сообщение от бота
   3. выполняется анализ прописан ли данный пользователь телеграм в каком-то из аккаунтов.
   4. Если пользователь и аккаунт найден, в атрибуты аккаунта сохраняется идентификатор чата телеграм, для дальнейшей
   отправки нотификаций в этот чат
   5. в чат отправляется сообщение что нотификации включены
2. Отписка от нотификаций.
   1. Пользователь телеграм отправляет боту OrderMonitorBot команду /stop
   2. модуль клиент телеграм получает сообщение от бота
   3. выполняется анализ прописан ли данный пользователь телеграм в каком-то из аккаунтов.
   4. Если пользователь и аккаунт найден, из атрибута аккаунта удаляется идентификатор чата телеграм
   5. в чат отправляется сообщение что нотификации отключены
3. Цикл проверки состояния ордеров.
   1. Цикл стартует по расписанию с заданным интервалом. Интервал по умолчанию 10000 мс. Интервал может быть изменен
   (см. REST API)
   2. По очереди перебираем каждую хранящуюся в БД биржу
   3. Для каждой биржи берем список аккаунтов, у которых прописан ID чата в телеграм (признак что требуется нотификация)
   4. Для каждого аккаунта выполняем запрос к бирже, используя сохраненные в файле настроек ключи, получаем список 
   активных ордеров
   5. Сравниваем список активных ордеров на бирже и список активных ордеров хранящийся на сервисе. Формируем список
   новых ордеров и список завершенный ордеров.
   6. Для каждого нового ордера сохраняем информацию о нем на сервисе и отправляем нотификацию в чат телеграм
   7. Для каждого завершенного ордера выполняем запрос к бирже, получаем его статус 
   (позволяет уточнить причину его завершения: был ли ордер исполнен или отменен).
   8. Обновляем статус завершенного ордера на сервисе и отправляем нотификацию в чат телеграм.
4. Запрос к REST API. Список методов смотри ниже.
   1. пользователь или внешняя система выполняет запрос к методу
   2. метод отрабатывает в соответствии с назначением (см. ниже в разделе REST API)
   3. пользователю или внешней системе возвращается ответ.

REST API:
1. /api/monitor
   a) set-period - получение периода проверки ордеров. В миллисекундах
   б) get-period - установка период проверки ордеров. В миллисекундах
2. /api/stock-exchange   
   a) get-list - возвращает список бирж
   б) create - создает новую запись о бирже
   в) update - обновляет информацию о бирже
   г) delete - удаляет запись о бирже
3. /api/account
   a) get-list - возвращает список аккаунтов по заданной бирже 
   б) create - создает новую запись об аккаунте на заданной бирже
   в) update - обновляет информацию об аккаунте
   г) delete - удаляет запись об аккаунте
4. /api/order
   a) get-list - Возвращает список ордеров хранящихся в БД (в т.ч. завершенных), отфильтрованных по параметрам.
